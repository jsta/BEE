# Launching BEE on Dora/OpenStack

## Install

When installing BEE with poetry, you'll need to make sure that the
`cloud_extras` packages are installed. To do this run

`poetry install -E cloud_extras`

## Configuration

Initially, cloud configuration was stored in the bee.conf file under a `[cloud]`
section. This creates some configuration issues when working with multiple
configuration files, so instead I've redesigned the cloud launcher to work with
a YAML configuration file that is specific to the cloud platform being used.
Below are a list of the main configuration options that are required.

* `private_key_file`: path to the private key file used for the head instance
* `bee_user`: user to be created on head instance (most likely the default user
   created -- cloud-user for RHEL and debian for debian images)
* `tm_listen_port`: listening port of the remote TM
* `wfm_listen_port`: listening port of the local WFM
* `head_node`: name of the head node where the TM will be launched
* `template_file`: path to the template file to launch the cloud setup from
* `provider`: name of provider (`google`, `openstack`, `chameleoncloud`)
* `tm_launch_cmd`: path to a script generated by the template. This is `/bee/tm`
  for the default Dora template.

As an example here is the current configuration that I'm using on my account:

```
private_key_file: /home/jtronge/key
bee_user: debian
tm_listen_port: 7777
tm_launch_cmd: /bee/tm
head_node: bee-server
template_file: /home/jtronge/BEE_Private/templates/dora-template.yaml
provider: openstack
...lines omitted...
```

### Template Specific Configuration

To provide support for various templates and providers, an extra parameter
`provider_parameters` should be included in the YAML config file. This is a
dictionary object of parameters that will be passed to the template file upon
cloud setup. These parameters will vary based upon what each template file
requires. Note that the main configuration options, as listed in the section
above, will be passed to the template file as well, but prefixed with `beeflow_`
to avoid clashes with template specific parameters.

For the `templates/dora-template.yaml` here are the required parameters:

* `stack_name`: name of the stack to be created
* `key_name`: name of the key, as shown in OpenStack
* `public_net`: public network name (external for Dora)
* `github_pat`: this is a GitHub PAT credential (see [Creating a personal access token](https://docs.github.com/en/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token)).
  This is needed to clone the BEE repo on the instance. Once BEE is public this won't be necessary.
* `git_branch`: branch of BEE to check out (`milestone-cloud`)
* `https_proxy`: HTTPS proxy env value (same as do-sn1)
* `http_proxy`: HTTP proxy env value (same as do-sn1)
* `no_proxy`: no proxy value (same as do-sn1)

Also, for OpenStack on Dora, the BEE image is based on a Debian 10 openstack
image which can be downloaded [here](http://cloud.debian.org/images/cloud/OpenStack/current-10/).
The [debian-10-openstack-amd64.qcow2](http://cloud.debian.org/images/cloud/OpenStack/current-10/debian-10-openstack-amd64.qcow2)
image should work with the template.

## Launch Script

The cloud launcher script assumes that the openstack environment variables are
already properly set by running the project rc script. Once that is done,
to set up the actual stack from the template file, you can run:

`beeflow-cloud --setup-cloud [CLOUD YAML CONFIG]`

To facilitate moving data onto the instances, I've included a `--copy` option
that copies files listed in the `copy_files` parameter of the config. I've been
using this to copy over pre-built containers to the instances.

After doing a couple test runs, I've noticed that the BEE install step
sometimes takes longer than expected. After the `--setup-cloud` option has run
and returned, `poetry install` will likely still be running on the instance.
So, before running the Task Manager, you may have to wait for 5-10 minutes at
a minimum.

## Running BEE

First the GDB and the scheduler will need to be started as usual with
`beeflow --gdb --sched`. The Workflow Manager could probably be started this
way as well, but it's easier to launch it manually to see the debug output.
To launch the workflow manager you also need to make sure that `$no_proxy`
includes localhost, since this is how the WFM contacts the TM.

`no_proxy=localhost,$no_proxy python -m beeflow.wf_manager ~/.config/beeflow/bee.conf`

To launch the Task Manager, I've included an option in my cloud launcher script
which starts it and then sets up an SSH tunnel to the local machine. Run this:

`beeflow-cloud --tm [CLOUD YAML CONFIG]`

This will show the debug output of the TM on the remote system and should also
show the output of running individual steps.

I've created a modified version of the client to quickly launch workflows
directly from the command line or a script.  You can run
`./src/beeflow/client/client_cli.py --workflow-path [PATH TO WORKFLOW]`, or use
the original client.py script.
